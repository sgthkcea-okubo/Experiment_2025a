<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Experiment_2025a</title>
  <script src="https://unpkg.com/jspsych@8.2.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.1.0"></script>
  <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>

<body></body>

<script>
const jsPsych = initJsPsych();
let timeline = [];

var welcome = {
  type: jsPsychHtmlButtonResponse,
  stimulus: "<p>実験に参加いただきありがとうございます。</p>",
  choices: ["開始"]
};
timeline.push(welcome);

// === ループ設定 ===
const num_of_loops = 5;
let continueNested = true;
let loop_timeline = [];

for (let i = 0; i < num_of_loops; i++) {
  let a = jsPsych.randomization.randomInt(-50, 50);
  let left_color = "blue";
  let right_color = "yellow";

  // === ① スライダー試行 ===
  const illusion_or_not = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <div style="text-align:center;">
        <canvas id="illusion_canvas_${i}" width="600" height="300" style="border:1px solid #ccc;"></canvas>
        <br>
        <p>図形が等しく見えるように調整してください。</p>
        <input type="range" id="r_diff_input_${i}" min="-50" max="50" value="0" step="1" style="width:80%;">
        <span id="r_diff_value_${i}">0</span>
        <p>回答の自信度をスライダーで選んでください。</p>
        <input type="range" id="confidence_input_${i}" min="0" max="100" value="50" step="1" style="width:80%;">
        <span id="confidence_value_${i}">50%</span>
      </div>
    `,
    choices: ["次に進む"],
    on_load: function() {
      const canvas = document.getElementById(`illusion_canvas_${i}`);
      const ctx = canvas.getContext("2d");
      const base = 100;

      function drawIllusion(r_diff) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.arc(200, 150, base - a - Number(r_diff), 0, 2 * Math.PI);
        ctx.fillStyle = left_color;
        ctx.fill();
        ctx.beginPath();
        ctx.arc(400, 150, base + a + Number(r_diff), 0, 2 * Math.PI);
        ctx.fillStyle = right_color;
        ctx.fill();
      }
      drawIllusion(0);

      const rInput = document.getElementById(`r_diff_input_${i}`);
      const rSpan = document.getElementById(`r_diff_value_${i}`);
      const cInput = document.getElementById(`confidence_input_${i}`);
      const cSpan = document.getElementById(`confidence_value_${i}`);

      rInput.addEventListener("input", () => {
        drawIllusion(rInput.value);
        rSpan.textContent = rInput.value;
      });
      cInput.addEventListener("input", () => {
        cSpan.textContent = cInput.value + "%";
      });
    },
    on_finish: function(data) {
      // ★修正ポイント: 値をここで直接取得
      const rInput = document.getElementById(`r_diff_input_${i}`);
      const cInput = document.getElementById(`confidence_input_${i}`);
      data.illusion_value = rInput ? Number(rInput.value) : null;
      data.confidence_value = cInput ? Number(cInput.value) : null;
      data.model_answer = -a;
      data.left_color = left_color;
      data.right_color = right_color;
    }
  };

  // === ② 正答表示 ===
  const model_answer = {
    type: jsPsychHtmlButtonResponse,
    stimulus: function() {
      // ★修正ポイント: 直前 trial の data を直接参照
      const last_trial = jsPsych.data.get().last(1).values()[0];
      const illusion_value = last_trial.illusion_value ?? "未回答";
      const correct = last_trial.model_answer ?? "不明";
      return `<p>正答は「${correct}」であり、あなたの回答は ${illusion_value} でした。</p>`;
    },
    choices: ["次に進む", "ループ後の質問へジャンプ"],
    on_finish: function(data) {
      if (data.response === 1) {
        continueNested = false;
        data.jump_requested = true;
      } else {
        data.jump_requested = false;
      }
    }
  };

  // ループブロックに追加
  loop_timeline.push({
    timeline: [illusion_or_not, model_answer],
    conditional_function: function() {
      return continueNested;
    }
  });
}

// === ループ全体を timeline に追加 ===
timeline.push({ timeline: loop_timeline });

const finish = {
  type: jsPsychHtmlButtonResponse,
  stimulus: "<p>これで終了です。</p>",
  choices: ["データ送信"]
};
timeline.push(finish);

jsPsych.run(timeline);
</script>
</html>
