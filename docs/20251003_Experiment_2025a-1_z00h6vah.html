<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Experiment_2025a</title>
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.1.0"></script>
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <meta charset="UTF-8">
    <script src="https://sgthkcea-okubo.github.io/jspsych-psychophysics/jspsych-psychophysics.js"></script>
    <script src="https://sgthkcea-okubo.github.io/jsPsychSheet/jspsychsheet.js"></script>
    <link rel="stylesheet" href="https://sgthkcea-okubo.github.io/jsPsychSheet/jspsychsheet.css">
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<style>
button.jspsych-btn { min-width: 120px; height:48px; font-size:18px; border-radius:8px; }
.slider-labels { display:flex; justify-content:space-between; font-size:14px; margin-bottom:5px; }
</style>
</head>
<body></body>
<script>
const jsPsych = initJsPsych({});

let last_illusion_data = null;
let illusion_value_map = {};
let confidence_value_map = {};
let continueNested = true;

let timeline = [];

// ウェルカム
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: 
    `<div style="width:100%; max-width:720px;">
      <style>
          pre {
          white-space: pre-wrap;
          word-wrap: break-word; /* 必要に応じて追加 */
          }
      </style>
      <pre style="text-align:left;">
（下にスクロールして読み進め、アンケートに進む場合はページ下部のボタンを押してください。）
<strong>参加者の皆様へ。</strong>

この研究にご参加いただき、ありがとうございます。この研究は、みなさんの知覚経験と信念の関連を調べるものです。 この調査の結果は、哲学的理論の構築や批判に寄与することになります。

<strong>自主的な参加と秘密保持</strong>

この研究への参加は完全に任意であり、参加を拒否することも、また、いつでも、いかなる理由でも、ペナルティなしに参加を撤回することができます。

この研究への参加は秘密厳守です。あなたが提供した情報には、この研究に携わる研究者と研究責任者のみがアクセスすることができます。また、データの分析はすべて集計された上で行われます。つまり、すべての参加者のデータの集計値が分析され、あなたの個々の回答が具体的に分析されることは決してありません。さらに、研究結果の公表はすべて匿名とし、個人を特定できるような情報がデータに関連付けられることはありません。

<strong>匿名データセットの保存</strong>

論文公開後は、この研究で収集された情報は、完全に匿名化された上で、オープンサイエンス・フレームワークなどのオンラインデータリポジトリを通じて一般に公開されます。これにより、質の高い科学研究に貢献することができます。例えば、他の研究者は、実施した分析を繰り返したり、別の仮説を検証したりすることができます。

-----------------------------

<strong>インフォームドコンセント</strong>

私は、本研究の内容と目的について十分に説明され、本研究に参加することに同意します。私は、ペナルティを負うことなく、いつでも自由に参加を取りやめることができることを理解しています。
      </pre>
    </div>`,
  choices: ['アンケートに進む']
});

// 名前入力
timeline.push({
  type: jsPsychSurveyText,
  questions: [{prompt:'回答者の名前を入力してください。'}]
});

// 色セット
const colorset1_1 = ["blue","indigo","violet"];
const colorset1_2 = ["yellow","yellowgreen","orange"];
const colorset1 = [colorset1_1, colorset1_2];
const condition = 1;
const num_of_loops = 100;

for(let i=0;i<num_of_loops;i++){
  const colorcond1 = jsPsych.randomization.sampleWithReplacement(colorset1,1)[0];
  const colorcond2 = jsPsych.randomization.sampleWithReplacement(colorset1.filter(c=>c!==colorcond1),1)[0];
  const color1 = jsPsych.randomization.sampleWithReplacement(colorcond1,1)[0];
  const color2 = (condition===1) ? jsPsych.randomization.sampleWithReplacement(colorcond2,1)[0]
                                : jsPsych.randomization.sampleWithReplacement(colorcond1,1)[0];
  const left_color_i=color1;
  const right_color_i=color2;
  const a = jsPsych.randomization.randomInt(-50,50);

  const illusion_or_not = {
    type: jsPsychHtmlButtonResponse,
    name: 'illusion_or_not_' + i,
    stimulus: `<div style="max-width:720px; margin:0 auto;">
      <p>下の画像に示された2つの図形の大きさが等しくなるようスライダー1の値を調整し、その調整への自信の程度を7段階で評価しスライダー2を用いて回答してください。<br>
      スライダー1とスライダー2の操作が済み次第、「次に進む」のボタンをを押してください。</p>
      <div style="display:flex; justify-content:center;">
        <canvas id="illusion_canvas_${i}" width="800" height="400" style="background:white; border:1px solid #ccc;"></canvas>
      </div>
      <input type="range" id="r_diff_input_${i}" min="-50" max="50" value="0" step="1" style="width:100%;">
      <div>（スライダー1）上に示された図形の大きさの調整に関する値: <span id="r_diff_value_${i}">0</span></div>
      <div class="slider-labels"><span>自信が無い</span><span>自信が有る</span></div>
      <input type="range" id="confidence_input_${i}" min="1" max="7" value="4" step="1" style="width:100%;">
      <div>（スライダー2）スライダー1の調整に関する自己評価の値: <span id="confidence_value_${i}">4</span></div>
    </div>`,
    choices:['次に進む'],
    on_load: function(){
      const canvas=document.getElementById('illusion_canvas_' + i);
      const ctx=canvas.getContext('2d');
      const base_radius=100;
      const offset=a;
      function drawIllusion(r_diff){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.beginPath();
        ctx.arc(250,200,base_radius - offset - r_diff,0,2*Math.PI);
        ctx.fillStyle=left_color_i; ctx.fill();
        ctx.beginPath();
        ctx.arc(550,200,base_radius + offset + r_diff,0,2*Math.PI);
        ctx.fillStyle=right_color_i; ctx.fill();
      }
      drawIllusion(0);
      const rInput=document.getElementById('r_diff_input_' + i);
      const cInput=document.getElementById('confidence_input_' + i);
      rInput.oninput=function(){ illusion_value_map[i]=Number(this.value); document.getElementById('r_diff_value_'+i).textContent=this.value; drawIllusion(Number(this.value)); };
      cInput.oninput=function(){ confidence_value_map[i]=Number(this.value); document.getElementById('confidence_value_'+i).textContent=this.value; };
      illusion_value_map[i]=Number(rInput.value);
      confidence_value_map[i]=Number(cInput.value);
    },
    on_finish: function(data){
      data.illusion_value = illusion_value_map[i] ?? null;
      data.confidence_value = confidence_value_map[i] ?? null;
      data.left_color = left_color_i;
      data.right_color = right_color_i;
      data.model_answer = -a;
      last_illusion_data = data; // ここで必ず更新
    }
  };

  const model_answer = {
    type: jsPsychHtmlButtonResponse,
    name: 'model_answer_' + i,
    choices: ['次に進む','ループ後の質問へジャンプ'],
    stimulus: function(){
      if(!last_illusion_data) return "直前の回答が取得できませんでした。";
      return `正答は「${last_illusion_data.model_answer}」、あなたの回答は ${last_illusion_data.illusion_value} です。`;
    },
    on_finish: function(data){
      if(data.response===1) continueNested=false;
    }
  };

  timeline.push({
    timeline:[illusion_or_not,model_answer],
    conditional_function:function(){ return continueNested; }
  });
}

// 使用機器
 var equip = {
    type: jsPsychSurveyMultiChoice,
    questions: [
        {prompt: "使用機器を回答してください",
         options: jsPsych.randomization.repeat(['デスクトップPC', 'ノートPC', 'スマートフォン', 'その他'], 1),
         required: true,
         horizontal: true,
         name: 'equip' 
        },
    ],
    button_label: '次へ',
};
timeline.push(equip);

var finish = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p>これでアンケートは終わりです。<br>' +
        '以下のボタンから回答を送信してください。<br>' +
        '回答データの送信後、活動報告に記入していただくパスワードが表示されます。</p>',
    choices: ['回答データを送信'],
    on_finish: function() {
        url = "https://script.google.com/macros/s/AKfycbyui_sjh61KU2998sL6YyN0Q6wG7RdkOTlMwoWnicte0a1lMuKVcwsnK5oTcE5HnmcNzw/exec";
        
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "text/plain"
          },
          body: JSON.stringify({
            subID: null,
            getSubID: 0,
            data: jsPsych.data.get().csv()
          })
        })
        .then(response => response.text())
        .then(text => {
          try {
            const result = JSON.parse(text);
            console.log("成功:", result);
          } catch (e) {
            console.error("JSONパース失敗:", text);
          }
        })
        .catch(error => console.error("fetch失敗:", error));
    }
};
timeline.push(finish);

var thanks = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: '<p>これでアンケートは終わりです。<br>' +
        '以下のパスワードを、記録したうえで、活動報告の欄に入力してください。<br>' +
        'Pass: xxxxxxxx<br>' +
        'パスワードの記録が済み次第、タブを閉じ実験への参加を終了してください。<br>' +
        '実験に参加いただき、ありがとうございました。</p>',
  choices: 'NO_KEYS'
};
timeline.push(thanks);

jsPsych.run(timeline);
</script>
</html>
